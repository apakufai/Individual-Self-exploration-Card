<!doctype html>
<html lang="ru">

</html>

<head>
	<meta charset="utf-8">
	<title>Главная. ИКС-файл</title>
	<script type="text/javascript"></script>
	<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
	<link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
</head>

<body>

	<section class="vertical_lines">
		<img class="line_1" src="{{ url_for('static', filename='images/line.svg') }}">
		<img class="line_2" src="{{ url_for('static', filename='images/line.svg') }}">
		<img class="line_3" src="{{ url_for('static', filename='images/line.svg') }}">
		<img class="line_4" src="{{ url_for('static', filename='images/line.svg') }}">
		<img class="line_5" src="{{ url_for('static', filename='images/line.svg') }}">
		<img class="line_6" src="{{ url_for('static', filename='images/line.svg') }}">
		<img class="line_7" src="{{ url_for('static', filename='images/line.svg') }}">
		<img class="line_8" src="{{ url_for('static', filename='images/line.svg') }}">
	</section>
	<section class="horizontal_lines">
		<img class="line_9" src="{{ url_for('static', filename='images/line.svg') }}">
		<img class="line_10" src="{{ url_for('static', filename='images/line.svg') }}">
		<img class="line_11" src="{{ url_for('static', filename='images/line.svg') }}">
		<img class="line_12" src="{{ url_for('static', filename='images/line.svg') }}">
		<img class="line_13" src="{{ url_for('static', filename='images/line.svg') }}">
		<img class="line_14" src="{{ url_for('static', filename='images/line.svg') }}">
		<img class="line_15" src="{{ url_for('static', filename='images/line.svg') }}">
		<img class="line_16" src="{{ url_for('static', filename='images/line.svg') }}">
		<img class="line_17" src="{{ url_for('static', filename='images/line.svg') }}">
		<img class="line_18" src="{{ url_for('static', filename='images/line.svg') }}">
		<img class="line_19" src="{{ url_for('static', filename='images/line.svg') }}">
		<img class="line_20" src="{{ url_for('static', filename='images/line.svg') }}">
	</section>

	<main name="descr_index">
		<img class="logo" src="{{ url_for('static', filename='images/ISeC-file_reverse.svg') }}" alt="ИКС-ФАЙЛ">
		<!-- ВСПЛЫВАЮЩЕЕ ОКНО ПУСТОГО ПОЛЯ ДЛЯ ВВОДА КОДА -->
		<div class="popup" id="popup_start_empty">
			<div class="popup_content">
				<p class="error_title">Ошибка</p>
				<p>Поле ввода пустое</p>
				<button class="close_btn" id="closeBtn_start_empty">Закрыть</button>
			</div>
		</div>

		<!-- ВСПЛЫВАЮЩЕЕ ОКНО НЕВЕРНОГО КОДА -->
		<div class="popup" id="popup_start_error">
			<div class="popup_content">
				<p class="error_title">Ошибка</p>
				<p>Введённый код неверен</p>
				<button class="close_btn" id="closeBtn_start_error">Закрыть</button>
			</div>
		</div>

		<!-- НАЧАЛЬНЫЙ ЭКРАН -->

		<div class="descr_main">
			<p class="descr_main_text">&emsp;Этот сайт даёт возможность анонимно пройти аудит персонального стиля
				влияния в
				переговорах.
			</p>
			<p class="descr_main_models">Знаете ли Вы, что есть пять моделей влияния в коммуникациях:
			</p>
			<section class="models_1">
				<b>ДЕЛОВАЯ</b>
				<b>РЕГЛАМЕНТНАЯ</b>
				<b>СИЛОВАЯ</b>
			</section>
			<section class="models_2">
				<b>МАНИПУЛЯТИВНАЯ</b>
				<b>ИДЕОЛОГИЧЕСКАЯ</b>
			</section>
			<p class="descr_main_text">&emsp;Ресурс влияния в переговорах связан с умением вариативно и осознанно
				использовать
				большое число коммуникативных инструментов. Обычно человек использует две-три любимые и привычные модели
				влияния. Комбинация привычных моделей определяет персональный переговорный профиль. Он связан с
				профессией и жизненным опытом. Он может измеряться и развиваться.</p>
			<p class="descr_main_text">
				&emsp;Чтобы узнать свой профиль и получить рекомендации по его развитию, надо пройти алгоритм, и, по
				возможности, запросить консультацию.
			</p>
			<p class="descr_main_text_lastString">&emsp;Алгоритм доступен участникам событий проекта <a
					class="linkSmartSkills" target="_blank" href="https://smart-skills.pro/"><b>SMART-SKILLS</b></a> по
				специальному коду.</p>
		</div>
		<div class="low_section">
			<button id="getCode" class="btn_startpage" type="button">Получить код</button>
			<input id="inp_code" class="inp_startpage" type="text" required placeholder="Введите код">
			<button id="startTest" class="btn_startpage" type="button">Пройти тест</button>
		</div>

		<script src="{{ url_for('static', filename='js/functions.js') }}"></script>
		<script>
			document.addEventListener("DOMContentLoaded", function () {

				// Переменные всплывающего окна
				const popup_start_empty = document.getElementById('popup_start_empty');
				const closeBtn_start_empty = document.getElementById('closeBtn_start_empty');
				const popup_start_error = document.getElementById('popup_start_error');
				const closeBtn_start_error = document.getElementById('closeBtn_start_error');

				// Переменные и функция перелистывания вперед
				const nextButton_start = document.getElementById("startTest");
				nextButton_start.addEventListener("click", async function () {
					const inputCode = document.getElementById('inp_code').value;

					if (inputCode.length === 0) {  // Если код не введён
						popup_start_empty.style.display = 'flex'; // Показываем всплывающее окно
					} else {  // Отправляем запрос на сервер для проверки кода
						const response = await fetch('/check_code', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({ code: inputCode })
						});

						const data = await response.json();

						if (data.error) {
							// Обработка ошибок
							if (data.error === 'connect_error') {
								alert('Ошибка подключения к базе данных.'); // Сообщение об ошибке подключения
							} else if (data.error === 'accessCode_not_found') {
								popup_start_error.style.display = 'flex'; // Показываем всплывающее окно, если код не найден
							}
						} else {

							// Получаем значения из полей ввода
							const userGroup = data.testGroup // Выводим testGroup
							sessionStorage.setItem('userGroup', userGroup); // Сохраняем userGroup в sessionStorage

							// Генерация id
							
							async function generateUniqueId() {
								let isIdFree = false; // Счётчик проверки на существование id в базе
								let IdToCheck; // Объявляем переменную для ID

								do {
									IdToCheck = generateRandomID(8); // Сгенерированный id
									// Отправляем запрос на сервер для проверки id
									const response = await fetch('/check_id', {
										method: 'POST',
										headers: {
											'Content-Type': 'application/json'
										},
										body: JSON.stringify({ userId: IdToCheck }) // Передаем JSON
									});
									const data = await response.json();
									if (data.error === 'connect_error') {
										alert('Ошибка подключения к базе данных.'); // Сообщение об ошибке подключения
										return null; // Выход из функции при ошибке
									}
									if (data.found) {
									} else {
										isIdFree = true; // ID свободен
									}
								} while (!isIdFree);

								return IdToCheck; // Возвращаем уникальный ID
							}

							// Генерация случайного id
							function generateRandomID(length) {
								let result = '';
								const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
								const charactersLength = characters.length;
								for (let i = 0; i < length; i++) {
									result += characters.charAt(Math.floor(Math.random() * charactersLength));
								}
								return result;
							}

							// Вызов функции и присвоение результата переменной userId
							generateUniqueId().then(id => {
								userId = id;
								sessionStorage.setItem('userId', userId);  // Сохранение id в sessionStorage
							});

							// Отправляем ключ "indexPass" со значением "true" на сервер
							fetch('/set_index_pass', {
								method: 'POST',
								headers: {
									'Content-Type': 'application/json'
								},
								body: JSON.stringify({ indexPass: true })
							});

							// Переход на другую страницу после окончания анимации при нажатии на кнопку
							const lines = document.querySelectorAll('.vertical_lines, .horizontal_lines');
							lines.forEach(line => line.classList.add('animBlockDisappear_end'));
							nextPage(lines, '[name="descr_index"]', '/userDataInput');
						}
					};

					// Закрытие всплывающего окна пустого поля для ввода кода
					closeBtn_start_empty.addEventListener('click', function () {
						popup_start_empty.style.display = 'none'; // Скрываем всплывающее окно
					});

					// Закрытие всплывающего окна неверно введённого кода
					closeBtn_start_error.addEventListener('click', function () {
						popup_start_error.style.display = 'none'; // Скрываем всплывающее окно
					});
				});
			});
		</script>


	</main>

</body>

</html>